apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mosquitto
  namespace: mosquitto
spec:
  interval: 5m
  chart:
    spec:
      chart: mosquitto
      version: "4.8.2"
      sourceRef:
        kind: HelmRepository
        name: k8s-at-home
        namespace: mosquitto
      interval: 5m
  values:
    image:
      repository: eclipse-mosquitto
      tag: "2.0.18"

    service:
      main:
        type: LoadBalancer
        ports:
          mqtt:
            enabled: true
            port: 1883

    auth:
      enabled: true

    persistence:
      data:
        enabled: true
        storageClass: "longhorn"
        accessMode: ReadWriteOnce
        size: 1Gi
      configinc:
        enabled: true
        storageClass: "longhorn"
        accessMode: ReadWriteOnce
        size: 100Mi

    config: |
      listener 1883
      allow_anonymous false
      password_file /mosquitto/configinc/passwordfile
      persistence true
      persistence_location /mosquitto/data
      log_dest stdout

    extraVolumeMounts:
      - name: mosquitto-password
        mountPath: /mosquitto/configinc/passwordfile
        subPath: passwordfile

    extraVolumes:
      - name: mosquitto-password
        secret:
          secretName: mosquitto-auth