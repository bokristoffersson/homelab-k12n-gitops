---
apiVersion: v1
kind: ConfigMap
metadata:
  name: iotdb-confignode-config
  namespace: iotdb
data:
  confignode-env.sh: |
    #!/bin/bash
    export IOTDB_HEAP_OPTS="-Xmx1G -Xms1G"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: iotdb-datanode-config
  namespace: iotdb
data:
  iotdb-datanode.properties: |
    # RPC Configuration
    dn_rpc_address=0.0.0.0
    dn_rpc_port=6667
    
    # MQTT Configuration
    enable_mqtt_service=true
    mqtt_host=0.0.0.0
    mqtt_port=1883
    mqtt_max_message_size=1048576
    
    # REST Configuration
    enable_rest_service=true
    rest_service_port=18080
    
    # Internal addresses will be set via environment variables
  datanode-env.sh: |
    #!/bin/bash
    export IOTDB_HEAP_OPTS="-Xmx2G -Xms2G"

---
# Headless service for ConfigNode StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: iotdb-confignode
  namespace: iotdb
  labels:
    app: iotdb
    component: confignode
spec:
  clusterIP: None
  publishNotReadyAddresses: true
  selector:
    app: iotdb
    component: confignode
  ports:
    - name: rpc
      port: 10710
      targetPort: 10710
    - name: consensus
      port: 10720
      targetPort: 10720

---
# Headless service for DataNode StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: iotdb-datanode
  namespace: iotdb
  labels:
    app: iotdb
    component: datanode
spec:
  clusterIP: None
  publishNotReadyAddresses: true
  selector:
    app: iotdb
    component: datanode
  ports:
    - name: rpc
      port: 6667
      targetPort: 6667
    - name: internal
      port: 10730
      targetPort: 10730
    - name: mpp
      port: 10740
      targetPort: 10740
    - name: data-cons
      port: 10750
      targetPort: 10750
    - name: schema-cons
      port: 10760
      targetPort: 10760
    - name: mqtt
      port: 1883
      targetPort: 1883
    - name: rest
      port: 18080
      targetPort: 18080

---
# ClusterIP service for client connections
apiVersion: v1
kind: Service
metadata:
  name: iotdb-service
  namespace: iotdb
  labels:
    app: iotdb
spec:
  type: ClusterIP
  selector:
    app: iotdb
    component: datanode
  ports:
    - name: rpc
      port: 6667
      targetPort: 6667
      protocol: TCP
    - name: rest
      port: 18080
      targetPort: 18080
      protocol: TCP

---
# LoadBalancer service for MQTT
apiVersion: v1
kind: Service
metadata:
  name: iotdb-mqtt
  namespace: iotdb
  labels:
    app: iotdb
  annotations:
  # Uncomment and configure if using MetalLB
  # metallb.universe.tf/address-pool: default
  # metallb.universe.tf/loadBalancerIPs: 192.168.1.100
spec:
  type: LoadBalancer
  selector:
    app: iotdb
    component: datanode
  ports:
    - name: mqtt
      port: 1883
      targetPort: 1883
      protocol: TCP

---
# ConfigNode StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: iotdb-confignode
  namespace: iotdb
  labels:
    app: iotdb
    component: confignode
spec:
  serviceName: iotdb-confignode
  replicas: 1
  selector:
    matchLabels:
      app: iotdb
      component: confignode
  template:
    metadata:
      labels:
        app: iotdb
        component: confignode
    spec:
      nodeSelector:
        kubernetes.io/hostname: worker-pi5
      containers:
        - name: confignode
          image: apache/iotdb:1.3.3-confignode
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 10710
              name: rpc
            - containerPort: 10720
              name: consensus
          env:
            - name: cn_internal_address
              value: "iotdb-confignode-0.iotdb-confignode.iotdb.svc.cluster.local"
            - name: cn_internal_port
              value: "10710"
            - name: cn_consensus_port
              value: "10720"
            - name: cn_seed_config_node
              value: "iotdb-confignode-0.iotdb-confignode.iotdb.svc.cluster.local:10710"
            - name: schema_replication_factor
              value: "1"
            - name: data_replication_factor
              value: "1"
          volumeMounts:
            - name: data
              mountPath: /iotdb/data
            - name: logs
              mountPath: /iotdb/logs
            - name: config
              mountPath: /iotdb/conf/iotdb-confignode-config
              subPath: iotdb-confignode-config
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 2Gi
          livenessProbe:
            tcpSocket:
              port: 10710
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            tcpSocket:
              port: 10710
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
      volumes:
        - name: config
          configMap:
            name: iotdb-confignode-config
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: nvme-storage
        resources:
          requests:
            storage: 10Gi
    - metadata:
        name: logs
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: nvme-storage
        resources:
          requests:
            storage: 5Gi

---
# DataNode StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: iotdb-datanode
  namespace: iotdb
  labels:
    app: iotdb
    component: datanode
spec:
  serviceName: iotdb-datanode
  replicas: 1
  selector:
    matchLabels:
      app: iotdb
      component: datanode
  template:
    metadata:
      labels:
        app: iotdb
        component: datanode
    spec:
      nodeSelector:
        kubernetes.io/hostname: worker-pi5
      initContainers:
        - name: wait-for-confignode
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for ConfigNode to be ready..."
              until nc -z iotdb-confignode-0.iotdb-confignode.iotdb.svc.cluster.local 10710; do
                echo "ConfigNode not ready yet, waiting..."
                sleep 5
              done
              echo "ConfigNode is ready!"
      containers:
        - name: datanode
          image: apache/iotdb:1.3.3-datanode
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 6667
              name: rpc
            - containerPort: 10730
              name: internal
            - containerPort: 10740
              name: mpp
            - containerPort: 10750
              name: data-consensus
            - containerPort: 10760
              name: schema-cons
            - containerPort: 1883
              name: mqtt
            - containerPort: 18080
              name: rest
          env:
            - name: dn_rpc_address
              value: "0.0.0.0"
            - name: dn_rpc_port
              value: "6667"
            - name: dn_internal_address
              value: "iotdb-datanode-0.iotdb-datanode.iotdb.svc.cluster.local"
            - name: dn_internal_port
              value: "10730"
            - name: dn_mpp_data_exchange_port
              value: "10740"
            - name: dn_data_region_consensus_port
              value: "10750"
            - name: dn_schema_region_consensus_port
              value: "10760"
            - name: dn_seed_config_node
              value: "iotdb-confignode-0.iotdb-confignode.iotdb.svc.cluster.local:10710"
            - name: dn_mqtt_host
              value: "0.0.0.0"
            - name: dn_mqtt_port
              value: "1883"
            - name: enable_mqtt_service
              value: "true"
            - name: enable_rest_service
              value: "true"
            - name: rest_service_port
              value: "18080"
          volumeMounts:
            - name: data
              mountPath: /iotdb/data
            - name: logs
              mountPath: /iotdb/logs
            - name: config
              mountPath: /iotdb/conf/iotdb-datanode.properties
              subPath: iotdb-datanode.properties
          resources:
            requests:
              cpu: 1000m
              memory: 2Gi
            limits:
              cpu: 4000m
              memory: 4Gi
          livenessProbe:
            tcpSocket:
              port: 6667
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            tcpSocket:
              port: 6667
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
      volumes:
        - name: config
          configMap:
            name: iotdb-datanode-config
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: nvme-storage
        resources:
          requests:
            storage: 50Gi
    - metadata:
        name: logs
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: nvme-storage
        resources:
          requests:
            storage: 5Gi