apiVersion: batch/v1
kind: Job
metadata:
  name: test-aws-connection
  namespace: heatpump-mqtt
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: test
          image: postgres:16
          command:
            - /bin/bash
            - -c
            - |
              set -ex
              apt-get update -qq && apt-get install -y -qq awscli curl && apt-get clean
              
              echo "=== AWS Credentials Test ==="
              echo "AWS_REGION: $AWS_REGION"
              echo "S3_BUCKET: $S3_BUCKET"
              echo "S3_PREFIX: $S3_PREFIX"
              
              # Test AWS credentials
              echo "=== Testing AWS CLI access ==="
              echo "Access Key ID: $AWS_ACCESS_KEY_ID"
              aws configure list
              
              echo "=== Testing S3 bucket access ==="
              aws s3 ls s3://$S3_BUCKET/ --region $AWS_REGION || echo "Bucket list failed"
              
              echo "=== Testing write access ==="
              echo "test file from backup job" > /tmp/test-file.txt
              aws s3 cp /tmp/test-file.txt "s3://$S3_BUCKET/$S3_PREFIX/test-file.txt" --region $AWS_REGION || echo "Upload failed"
              
              echo "=== Verifying upload ==="
              aws s3 ls "s3://$S3_BUCKET/$S3_PREFIX/" --region $AWS_REGION || echo "List after upload failed"
              
              echo "=== Complete ==="
          env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: timescaledb-backup-aws
                  key: AWS_ACCESS_KEY_ID
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: timescaledb-backup-aws
                  key: AWS_SECRET_ACCESS_KEY
            - name: AWS_REGION
              valueFrom:
                secretKeyRef:
                  name: timescaledb-backup-aws
                  key: AWS_REGION
            - name: S3_BUCKET
              valueFrom:
                secretKeyRef:
                  name: timescaledb-backup-aws
                  key: S3_BUCKET
            - name: S3_PREFIX
              valueFrom:
                secretKeyRef:
                  name: timescaledb-backup-aws
                  key: S3_PREFIX
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi

