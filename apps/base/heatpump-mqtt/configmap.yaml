apiVersion: v1
kind: ConfigMap
metadata:
  name: heatpump-mqtt-config
  namespace: heatpump-mqtt
data:
  config.yaml: |
    mqtt:
      host: "mosquitto.mosquitto.svc.cluster.local"
      port: 1883
      client_id: "mqtt-to-timescale"
      keep_alive_secs: 30
      username: "$(MQTT_USER)"
      password: "$(MQTT_PASSWORD)"
      clean_session: true
      protocol: "v5"
    database:
      url: "postgresql://$(DATABASE_USER):$(DATABASE_PASSWORD)@timescaledb.heatpump-mqtt.svc.cluster.local:5432/timescaledb"
      write:
        batch_size: 500
        linger_ms: 500
    pipelines:
      - name: "heatpump"
        topic: "thermiq_heatpump/data"
        qos: 1
        table: "heatpump"
        timestamp:
          path: "$.timestamp"
          format: "unix_s"
          use_now: true
        tags:
          device_id: "$.device_id"
          room: "$.room"
        fields:
          outdoor_temp: { 
            path: "$.d0", 
            type: "float" 
          }
          supplyline_temp: { 
            path: "$.d5", 
            type: "float" 
          }
          returnline_temp: {
            path: "$.d6",
            type: "float"
          }
          hotwater_temp: {
            path: "$.d7",
            type: "float"
          }
          brine_out_temp: {
            path: "$.d8",
            type: "float"
          }
          brine_in_temp: {
            path: "$.d9",
            type: "float"
          }
          integral: {
            path: "$.d25",
            type: "float"
          }
          flowlinepump_speed: {
            path: "$.d30",
            type: "smallint"
          }
          brinepump_speed: {
            path: "$.d30",
            type: "smallint"
          }          
        bit_flags:
          - source_path: "$.d16"
            flags:
              0: "brinepump_on"
              1: "compressor_on"
              2: "flowlinepump_on"
              3: "hotwater_production"
              4: "circulation_pump"

      - name: "sensors"
        topic: "home/sensors/+/state"
        qos: 1
        table: "telemetry"
        timestamp: { use_now: true }
        tags:
          sensor: "$.name"
          location: "$.location"
        fields:
          temperature_c: { path: "$.temperature", type: "float" }
          humidity_pct: { path: "$.humidity", type: "float" }
