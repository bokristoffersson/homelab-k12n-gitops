apiVersion: batch/v1
kind: Job
metadata:
  name: backup-debug
  namespace: heatpump-mqtt
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: debug
          image: postgres:16
          command:
            - /bin/bash
            - -c
            - |
              set -e
              apt-get update > /dev/null 2>&1
              apt-get install -y -q awscli > /dev/null 2>&1
              apt-get clean > /dev/null 2>&1
              echo "=== Starting debug ==="
              echo "AWS CLI installed"
              echo "Testing database connection..."
              pg_dump --version || echo "pg_dump check failed"
              echo "Environment check:"
              echo "PGUSER=$PGUSER"
              echo "PGHOST=$PGHOST"
              echo "AWS_REGION=$AWS_REGION"
              echo "S3_BUCKET=$S3_BUCKET"
              echo "=== Done ==="
          env:
            - name: PGHOST
              value: "timescaledb.heatpump-mqtt.svc.cluster.local"
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: timescaledb-secret
                  key: POSTGRES_USER
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: timescaledb-secret
                  key: POSTGRES_PASSWORD
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: timescaledb-backup-aws
                  key: AWS_ACCESS_KEY_ID
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: timescaledb-backup-aws
                  key: AWS_SECRET_ACCESS_KEY
            - name: AWS_REGION
              valueFrom:
                secretKeyRef:
                  name: timescaledb-backup-aws
                  key: AWS_REGION
            - name: S3_BUCKET
              valueFrom:
                secretKeyRef:
                  name: timescaledb-backup-aws
                  key: S3_BUCKET

