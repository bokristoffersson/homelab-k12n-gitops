# apps/monitoring/loki/helmrelease.yaml
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: loki
  namespace: monitoring
spec:
  interval: 15m
  chart:
    spec:
      chart: loki
      version: 6.29.0
      sourceRef:
        kind: HelmRepository
        name: loki
        namespace: flux-system
      interval: 15m

  values:
    loki:
      auth_enabled: false
      commonConfig:
        replication_factor: 1
      storage:
        type: filesystem

    # Single binary deployment (simpler for homelabs)
    singleBinary:
      replicas: 1
      persistence:
        enabled: true
        storageClass: nvme-storage
        size: 20Gi

      # Node affinity to pin to worker-pi5
      nodeSelector:
        kubernetes.io/hostname: worker-pi5

      # Alternative: use affinity for more control
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: In
                    values:
                      - worker-pi5