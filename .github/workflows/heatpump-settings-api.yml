name: heatpump-settings-api CI/CD

on:
  push:
    branches: [main]
    paths:
      - "applications/heatpump-settings-api/**"
      - ".github/workflows/heatpump-settings-api.yml"
  pull_request:
    branches: [main]
    paths:
      - "applications/heatpump-settings-api/**"
      - ".github/workflows/heatpump-settings-api.yml"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: bokristoffersson/heatpump-settings-api

jobs:
  test:
    name: Test
    runs-on: homelab-runners
    env:
      RUSTFLAGS: ""  # Override setup-rust-toolchain's -D warnings
    defaults:
      run:
        working-directory: applications/heatpump-settings-api
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        uses: ./.github/actions/setup-rust-build-tools

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features

      - name: Run tests
        run: cargo test --verbose

  docker:
    name: Build and Push Docker Image
    runs-on: homelab-runners
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/arm64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client

      - name: Build and push with BuildKit
        run: |
          # Create registry credentials secret
          kubectl create secret generic buildkit-registry-${{ github.run_id }} \
            --from-literal=username=${{ github.actor }} \
            --from-literal=password=${{ secrets.GITHUB_TOKEN }} \
            --namespace=default

          # Create BuildKit pod
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Pod
          metadata:
            name: buildkit-${{ github.run_id }}
            namespace: default
          spec:
            restartPolicy: Never
            containers:
            - name: buildkit
              image: moby/buildkit:v0.17.2-rootless
              securityContext:
                runAsUser: 1000
                runAsGroup: 1000
              command:
              - sh
              - -c
              - |
                set -ex

                # Start buildkitd in background
                buildkitd --addr unix:///run/user/1000/buildkit/buildkitd.sock &
                BUILDKIT_PID=\$!

                # Wait for buildkitd to be ready
                timeout 60 sh -c 'until buildctl --addr unix:///run/user/1000/buildkit/buildkitd.sock debug workers; do sleep 1; done'

                # Clone the repository
                git clone --depth 1 --branch main https://github.com/${{ github.repository }}.git /tmp/repo
                cd /tmp/repo/applications/heatpump-settings-api

                # Login to registry
                echo "${{ secrets.GITHUB_TOKEN }}" | buildctl --addr unix:///run/user/1000/buildkit/buildkitd.sock build \
                  --frontend dockerfile.v0 \
                  --local context=. \
                  --local dockerfile=. \
                  --output type=image,name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main,name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }},push=true,registry.insecure=false \
                  --opt platform=linux/arm64 \
                  --export-cache type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max \
                  --import-cache type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache \
                  --metadata-file /tmp/metadata.json

                # Stop buildkitd
                kill \$BUILDKIT_PID || true
                wait \$BUILDKIT_PID || true
              env:
              - name: BUILDKIT_HOST
                value: unix:///run/user/1000/buildkit/buildkitd.sock
              - name: DOCKER_CONFIG
                value: /tmp/.docker
              volumeMounts:
              - name: registry-auth
                mountPath: /tmp/.docker-secret
            volumes:
            - name: registry-auth
              secret:
                secretName: buildkit-registry-${{ github.run_id }}
                items:
                - key: username
                  path: username
                - key: password
                  path: password
          EOF

          # Wait for pod to be created
          sleep 5

          # Stream logs
          kubectl logs -f buildkit-${{ github.run_id }} --namespace=default || true

          # Check if pod succeeded
          POD_STATUS=$(kubectl get pod buildkit-${{ github.run_id }} --namespace=default -o jsonpath='{.status.phase}')

          # Cleanup
          kubectl delete pod buildkit-${{ github.run_id }} --namespace=default || true
          kubectl delete secret buildkit-registry-${{ github.run_id }} --namespace=default || true

          # Exit with error if build failed
          if [ "$POD_STATUS" != "Succeeded" ]; then
            echo "BuildKit build failed with status: $POD_STATUS"
            exit 1
          fi
