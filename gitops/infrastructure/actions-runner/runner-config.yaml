apiVersion: v1
kind: ConfigMap
metadata:
  name: runner-config
  namespace: actions-runners
data:
  values.yaml: |
    githubConfigUrl: "https://github.com/bokristoffersson/homelab-k12n-gitops"
    githubConfigSecret: github-token

    minRunners: 0
    maxRunners: 3

    runnerScaleSetName: "homelab-runners"

    # NOTE: ARC does not support custom runner labels
    # Runners are targeted using the runner scale set name: "homelab-runners"
    # See: https://github.com/orgs/community/discussions/135911

    containerMode:
      type: "kubernetes"
      kubernetesModeWorkVolumeClaim:
        accessModes: ["ReadWriteOnce"]
        storageClassName: "longhorn"
        resources:
          requests:
            storage: 20Gi

    template:
      spec:
        securityContext:
          fsGroup: 123  # Match runner user group
        containers:
          - name: runner
            image: ghcr.io/actions/actions-runner:latest
            command:
              - /bin/bash
              - -c
              - |
                # Install build tools for Rust compilation (rdkafka-sys needs gcc, cmake, etc.)
                if ! command -v gcc &> /dev/null; then
                  apt-get update && \
                  apt-get install -y --no-install-recommends \
                    build-essential \
                    gcc \
                    g++ \
                    cmake \
                    pkg-config \
                    libssl-dev \
                    ca-certificates \
                    sudo && \
                  rm -rf /var/lib/apt/lists/*
                fi
                # Start the runner as the runner user (the script handles user switching)
                # Use sudo to switch to runner user if we're running as root
                if [ "$(id -u)" = "0" ]; then
                  exec sudo -u runner /home/runner/run.sh
                else
                  exec /home/runner/run.sh
                fi
            env:
              - name: ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER
                value: "false"  # Allow jobs without containers
            securityContext:
              runAsUser: 0  # Run as root to install packages, then switch to runner user via sudo
            resources:
              requests:
                cpu: "1"
                memory: "2Gi"
              limits:
                cpu: "2"
                memory: "4Gi"

    controllerServiceAccount:
      name: arc-controller-gha-rs-controller
      namespace: actions-runner-system

    listenerTemplate:
      spec:
        containers:
          - name: listener
            resources:
              requests:
                cpu: "100m"
                memory: "128Mi"
              limits:
                cpu: "200m"
                memory: "256Mi"
