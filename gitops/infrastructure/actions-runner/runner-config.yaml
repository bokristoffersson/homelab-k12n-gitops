apiVersion: v1
kind: ConfigMap
metadata:
  name: runner-config
  namespace: actions-runners
data:
  values.yaml: |
    githubConfigUrl: "https://github.com/bokristoffersson/homelab-k12n-gitops"
    githubConfigSecret: github-token

    minRunners: 0
    maxRunners: 3

    runnerScaleSetName: "homelab-runners"

    # NOTE: ARC does not support custom runner labels
    # Runners are targeted using the runner scale set name: "homelab-runners"
    # See: https://github.com/orgs/community/discussions/135911

    containerMode:
      type: "kubernetes"
      kubernetesModeWorkVolumeClaim:
        accessModes: ["ReadWriteOnce"]
        storageClassName: "longhorn"
        resources:
          requests:
            storage: 20Gi

    template:
      spec:
        serviceAccountName: homelab-runners-85d8f765-listener
        securityContext:
          fsGroup: 123  # Match runner user group
        containers:
          - name: runner
            image: ghcr.io/actions/actions-runner:latest
            command: ["/home/runner/run.sh"]
            env:
              - name: ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER
                value: "false"  # Allow jobs without containers
              - name: KUBECONFIG
                value: /etc/kubeconfig/config
            volumeMounts:
              - name: kubeconfig
                mountPath: /etc/kubeconfig
                readOnly: true
            resources:
              requests:
                cpu: "1"
                memory: "2Gi"
              limits:
                cpu: "2"
                memory: "4Gi"
        volumes:
          - name: kubeconfig
            secret:
              secretName: github-actions-kubeconfig
              items:
                - key: KUBECONFIG_DATA
                  path: config

    controllerServiceAccount:
      name: arc-controller-gha-rs-controller
      namespace: actions-runner-system

    listenerTemplate:
      spec:
        containers:
          - name: listener
            resources:
              requests:
                cpu: "100m"
                memory: "128Mi"
              limits:
                cpu: "200m"
                memory: "256Mi"
