apiVersion: v1
kind: ConfigMap
metadata:
  name: runner-config
  namespace: actions-runners
data:
  values.yaml: |
    githubConfigUrl: "https://github.com/bokristoffersson/homelab-k12n-gitops"
    githubConfigSecret: github-token

    minRunners: 0
    maxRunners: 3

    runnerScaleSetName: "homelab-runners"

    # NOTE: ARC does not support custom runner labels
    # Runners are targeted using the runner scale set name: "homelab-runners"
    # See: https://github.com/orgs/community/discussions/135911

    containerMode:
      type: "kubernetes"
      kubernetesModeWorkVolumeClaim:
        accessModes: ["ReadWriteOnce"]
        storageClassName: "longhorn"
        resources:
          requests:
            storage: 20Gi

    template:
      spec:
        securityContext:
          fsGroup: 123  # Match runner user group
        containers:
          - name: runner
            image: ghcr.io/actions/actions-runner:latest
            command:
              - /bin/bash
              - -c
              - |
                # Install build tools for Rust compilation (rdkafka-sys needs gcc, cmake, etc.)
                if ! command -v gcc &> /dev/null; then
                  apt-get update && \
                  apt-get install -y --no-install-recommends \
                    build-essential \
                    gcc \
                    g++ \
                    cmake \
                    pkg-config \
                    libssl-dev \
                    ca-certificates \
                    libcap2-bin && \
                  rm -rf /var/lib/apt/lists/*
                fi
                # Start the runner - try to run as runner user if we're root
                # Clear any sudo-related environment variables
                unset SUDO_USER SUDO_UID SUDO_GID SUDO_COMMAND 2>/dev/null || true
                # If running as root, try to switch to runner user using setpriv
                if [ "$(id -u)" = "0" ]; then
                  # Ensure runner directories have correct ownership
                  chown -R runner:runner /home/runner /opt/actions-runner 2>/dev/null || true
                  # Use setpriv to drop privileges (if available) or try direct execution
                  if command -v setpriv &> /dev/null; then
                    exec setpriv --reuid=1001 --regid=123 --clear-groups --init-groups /home/runner/run.sh
                  else
                    # Fallback: try running as root (runner may handle this)
                    exec /home/runner/run.sh
                  fi
                else
                  exec /home/runner/run.sh
                fi
            env:
              - name: ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER
                value: "false"  # Allow jobs without containers
            securityContext:
              runAsUser: 0  # Run as root to install packages, then drop to runner user
            resources:
              requests:
                cpu: "1"
                memory: "2Gi"
              limits:
                cpu: "2"
                memory: "4Gi"

    controllerServiceAccount:
      name: arc-controller-gha-rs-controller
      namespace: actions-runner-system

    listenerTemplate:
      spec:
        containers:
          - name: listener
            resources:
              requests:
                cpu: "100m"
                memory: "128Mi"
              limits:
                cpu: "200m"
                memory: "256Mi"
