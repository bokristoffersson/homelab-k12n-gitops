---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: mcp-routes
  namespace: traefik
spec:
  entryPoints:
    - web  # Port 8000
  routes:
    # Kubernetes MCP Server
    # Server expects: /mcp, /sse, /message paths (no base path support)
    # Using /mcp directly - future MCP servers will need subdomains
    - match: Host(`api.k12n.com`) && (Path(`/mcp`) || PathPrefix(`/sse`) || PathPrefix(`/message`))
      kind: Rule
      middlewares:
        - name: https-scheme
          namespace: traefik
        - name: cors
          namespace: traefik
        - name: security-headers
          namespace: traefik
      services:
        - name: kubernetes-mcp-server
          namespace: kubernetes-mcp-server
          port: 8080

---
# Middleware to strip /mcp/kubernetes prefix
# Server expects: /mcp, /sse, /message
# Requests come as: /mcp/kubernetes/*, /mcp/kubernetes/sse, /mcp/kubernetes/message
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: mcp-kubernetes-stripprefix
  namespace: traefik
spec:
  stripPrefix:
    prefixes:
      - /mcp/kubernetes
