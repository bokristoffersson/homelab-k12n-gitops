input:
  kafka:
    addresses:
      - redpanda-v2.redpanda-v2.svc.cluster.local:9092
    topics:
      - homelab-heatpump-telemetry
    consumer_group: homelab-settings
    start_from_oldest: false

pipeline:
  processors:
    - mapping: |
        root = this
        root.device_id = this.tags.device_id | ""
        root.indoor_target_temp = if this.fields.indoor_target_temp != null { this.fields.indoor_target_temp.number().floor() } else { null }
        root.mode = if this.fields.mode != null { this.fields.mode.number().floor() } else { null }
        root.curve = if this.fields.curve != null { this.fields.curve.number().floor() } else { null }
        root.curve_min = if this.fields.curve_min != null { this.fields.curve_min.number().floor() } else { null }
        root.curve_max = if this.fields.curve_max != null { this.fields.curve_max.number().floor() } else { null }
        root.curve_plus_5 = if this.fields.curve_plus_5 != null { this.fields.curve_plus_5.number().floor() } else { null }
        root.curve_zero = if this.fields.curve_zero != null { this.fields.curve_zero.number().floor() } else { null }
        root.curve_minus_5 = if this.fields.curve_minus_5 != null { this.fields.curve_minus_5.number().floor() } else { null }
        root.heatstop = if this.fields.heatstop != null { this.fields.heatstop.number().floor() } else { null }
        root.updated_at = now().ts_format("2006-01-02T15:04:05.999999999Z07:00")

output:
  sql_raw:
    driver: postgres
    dsn: postgres://postgres:postgres@postgres.homelab-settings.svc.cluster.local:5432/homelab_settings?sslmode=disable
    query: |
      INSERT INTO settings (device_id, indoor_target_temp, mode, curve, curve_min, curve_max, curve_plus_5, curve_zero, curve_minus_5, heatstop, updated_at)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)
      ON CONFLICT (device_id)
      DO UPDATE SET
        indoor_target_temp = EXCLUDED.indoor_target_temp,
        mode = EXCLUDED.mode,
        curve = EXCLUDED.curve,
        curve_min = EXCLUDED.curve_min,
        curve_max = EXCLUDED.curve_max,
        curve_plus_5 = EXCLUDED.curve_plus_5,
        curve_zero = EXCLUDED.curve_zero,
        curve_minus_5 = EXCLUDED.curve_minus_5,
        heatstop = EXCLUDED.heatstop,
        updated_at = EXCLUDED.updated_at
      WHERE settings.indoor_target_temp IS DISTINCT FROM EXCLUDED.indoor_target_temp
         OR settings.mode IS DISTINCT FROM EXCLUDED.mode
         OR settings.curve IS DISTINCT FROM EXCLUDED.curve
         OR settings.curve_min IS DISTINCT FROM EXCLUDED.curve_min
         OR settings.curve_max IS DISTINCT FROM EXCLUDED.curve_max
         OR settings.curve_plus_5 IS DISTINCT FROM EXCLUDED.curve_plus_5
         OR settings.curve_zero IS DISTINCT FROM EXCLUDED.curve_zero
         OR settings.curve_minus_5 IS DISTINCT FROM EXCLUDED.curve_minus_5
         OR settings.heatstop IS DISTINCT FROM EXCLUDED.heatstop
    args_mapping: |
      root = [
        this.device_id,
        this.indoor_target_temp,
        this.mode,
        this.curve,
        this.curve_min,
        this.curve_max,
        this.curve_plus_5,
        this.curve_zero,
        this.curve_minus_5,
        this.heatstop,
        this.updated_at
      ]
