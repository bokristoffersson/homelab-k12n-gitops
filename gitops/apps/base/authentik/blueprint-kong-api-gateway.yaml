---
apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprint-kong-api-gateway
  namespace: authentik
  labels:
    blueprints.goauthentik.io/instantiate: "true"
data:
  kong-api-gateway.yaml: |
    version: 1
    metadata:
      name: Kong API Gateway OAuth2 Provider
      labels:
        application: kong-api-gateway

    entries:
      # OAuth2/OpenID Provider for Kong API Gateway
      - model: authentik_providers_oauth2.oauth2provider
        id: kong-api-gateway-provider
        identifiers:
          client_id: kong-api-gateway
        attrs:
          name: Kong API Gateway
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          client_type: confidential
          client_id: kong-api-gateway
          # Client secret is managed via sealed secret in Kong namespace
          # The secret value should match what's stored in kong-oidc-secret
          redirect_uris: |
            https://api.k12n.com/callback
            http://localhost:8000/callback
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
          sub_mode: hashed_user_id
          include_claims_in_id_token: true
          issuer_mode: per_provider
          access_code_validity: minutes=1
          access_token_validity: hours=10
          refresh_token_validity: days=30

      # Application for Kong API Gateway
      - model: authentik_core.application
        id: kong-api-gateway-app
        identifiers:
          slug: api-gateway
        attrs:
          name: API Gateway
          slug: api-gateway
          provider: !KeyOf kong-api-gateway-provider
          policy_engine_mode: any
          meta_launch_url: https://api.k12n.com
          meta_description: Kong API Gateway with OAuth2 authentication
          open_in_new_tab: false
