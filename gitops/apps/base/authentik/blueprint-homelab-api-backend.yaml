---
apiVersion: v1
kind: ConfigMap
metadata:
  name: blueprint-homelab-api-backend
  namespace: authentik
  labels:
    blueprints.goauthentik.io/instantiate: "true"
data:
  homelab-api-backend.yaml: |
    version: 1
    metadata:
      name: Homelab API Backend OAuth2 Client
      labels:
        application: homelab-api-backend

    entries:
      # OAuth2 Provider for API backend token introspection
      # This is a confidential client used by homelab-api to validate tokens
      - model: authentik_providers_oauth2.oauth2provider
        id: homelab-api-backend-provider
        identifiers:
          name: homelab-api-backend
        attrs:
          name: Homelab API Backend
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
          # Confidential client - API backend can securely store secrets
          client_type: confidential
          client_id: homelab-api-backend
          # Client secret will be auto-generated by Authentik
          # Retrieve it from Authentik admin UI after blueprint applies
          redirect_uris: []
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
          sub_mode: hashed_user_id
          issuer_mode: per_provider
          # This client is only used for introspection, not for user auth
          access_token_validity: minutes=5

      # Application entry in Authentik
      - model: authentik_core.application
        id: homelab-api-backend-app
        identifiers:
          slug: homelab-api-backend
        attrs:
          name: Homelab API Backend
          slug: homelab-api-backend
          provider: !KeyOf homelab-api-backend-provider
          policy_engine_mode: any
          meta_description: Confidential client for homelab-api token introspection
