---
apiVersion: v1
kind: ConfigMap
metadata:
  name: blueprint-homelab-macos
  namespace: authentik
  labels:
    blueprints.goauthentik.io/instantiate: "true"
data:
  homelab-macos.yaml: |
    version: 1
    metadata:
      name: Homelab macOS OAuth2 Application
      labels:
        application: homelab-macos

    entries:
      # OAuth2/OpenID Provider for homelab-macos
      # Uses Authorization Code Flow with PKCE (RFC 7636)
      # This is the recommended flow for native desktop applications
      - model: authentik_providers_oauth2.oauth2provider
        id: homelab-macos-provider
        identifiers:
          name: homelab-macos
        attrs:
          name: Homelab macOS
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
          # Public client - native apps cannot securely store secrets
          # PKCE is enforced for public clients in Authentik
          client_type: public
          client_id: homelab-macos
          audience: "homelab-macos"
          # Custom URL scheme for native macOS app callback
          # Register this URL scheme in your app's Info.plist
          redirect_uris:
            - matching_mode: strict
              url: "homelab-macos://oauth/callback"
            # Loopback for development/testing (RFC 8252 Section 7.3)
            - matching_mode: strict
              url: "http://127.0.0.1:9876/callback"
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
          sub_mode: hashed_user_id
          include_claims_in_id_token: true
          issuer_mode: per_provider
          # Short-lived authorization code
          access_code_validity: minutes=1
          # Access token validity - reasonable for native app
          access_token_validity: hours=24
          # Refresh token validity - longer for native apps (better UX)
          refresh_token_validity: days=90

      # Application entry in Authentik
      - model: authentik_core.application
        id: homelab-macos-app
        identifiers:
          slug: homelab-macos
        attrs:
          name: Homelab macOS
          slug: homelab-macos
          provider: !KeyOf homelab-macos-provider
          policy_engine_mode: any
          meta_description: Native macOS application for homelab monitoring and control

      # Add custom scopes to the provider
      # These scopes are defined in blueprint-heatpump-web.yaml
      - model: authentik_providers_oauth2.oauth2provider
        id: homelab-macos-provider-scopes
        identifiers:
          name: homelab-macos
        state: present
        attrs:
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, read:energy]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, read:heatpump]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, read:settings]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, write:settings]]
