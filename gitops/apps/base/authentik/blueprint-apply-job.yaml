---
apiVersion: batch/v1
kind: Job
metadata:
  name: authentik-apply-blueprints
  namespace: authentik
  annotations:
    # This annotation makes Flux recreate the job on every sync
    kustomize.toolkit.fluxcd.io/force: "enabled"
spec:
  ttlSecondsAfterFinished: 300  # Clean up after 5 minutes
  template:
    metadata:
      labels:
        app: authentik-blueprint-applier
    spec:
      restartPolicy: OnFailure
      initContainers:
        # Wait for Authentik to be ready
        - name: wait-for-authentik
          image: curlimages/curl:8.5.0
          command:
            - sh
            - -c
            - |
              echo "Waiting for Authentik to be ready..."
              until curl -f -s http://authentik-server:9000/-/health/ready/; do
                echo "Authentik not ready yet, waiting..."
                sleep 5
              done
              echo "Authentik is ready!"
              sleep 10  # Extra wait for full initialization
      containers:
        - name: apply-blueprints
          image: ghcr.io/goauthentik/server:2024.12.1
          command:
            - /bin/sh
            - -c
            - |
              set -e

              echo "Starting blueprint application..."

              # Apply each blueprint file found in /blueprints/custom/
              for blueprint in /blueprints/custom/*.yaml; do
                if [ -f "$blueprint" ]; then
                  echo "Applying blueprint: $blueprint"
                  ak apply_blueprint "$blueprint" || {
                    echo "Warning: Failed to apply $blueprint (may already exist)"
                  }
                fi
              done

              echo "Blueprint application complete!"
          env:
            - name: AUTHENTIK_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: authentik-secret
                  key: AUTHENTIK_SECRET_KEY
            - name: AUTHENTIK_POSTGRESQL__HOST
              value: "authentik-postgres"
            - name: AUTHENTIK_POSTGRESQL__PORT
              value: "5432"
            - name: AUTHENTIK_POSTGRESQL__NAME
              valueFrom:
                secretKeyRef:
                  name: authentik-postgres-secret
                  key: POSTGRES_DB
            - name: AUTHENTIK_POSTGRESQL__USER
              valueFrom:
                secretKeyRef:
                  name: authentik-postgres-secret
                  key: POSTGRES_USER
            - name: AUTHENTIK_POSTGRESQL__PASSWORD
              valueFrom:
                secretKeyRef:
                  name: authentik-postgres-secret
                  key: POSTGRES_PASSWORD
            - name: AUTHENTIK_REDIS__HOST
              value: "authentik-redis"
            - name: AUTHENTIK_REDIS__PORT
              value: "6379"
          volumeMounts:
            - name: blueprints
              mountPath: /blueprints/custom
              readOnly: true
      volumes:
        - name: blueprints
          projected:
            sources:
              - configMap:
                  name: authentik-blueprint-heatpump-web
              - configMap:
                  name: authentik-blueprint-kong-api-gateway
              - configMap:
                  name: blueprint-oauth2-proxy
              - configMap:
                  name: blueprint-backstage
              - configMap:
                  name: blueprint-claude-mcp
              - configMap:
                  name: blueprint-redpanda-console
              - configMap:
                  name: authentik-blueprint-homelab-macos
              - configMap:
                  name: authentik-blueprint-homelab-macos
