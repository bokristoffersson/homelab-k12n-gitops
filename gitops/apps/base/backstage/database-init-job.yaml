---
apiVersion: batch/v1
kind: Job
metadata:
  name: backstage-database-init
  namespace: backstage
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: psql
        image: postgres:16-alpine
        command:
        - /bin/sh
        - -c
        - |
          echo "Creating backstage database..."
          
          psql -h timescaledb.heatpump-mqtt.svc.cluster.local \
               -p 5432 \
               -U ${POSTGRES_USER} \
               -d postgres <<EOF
          SELECT 'CREATE DATABASE backstage'
          WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'backstage')\gexec
          EOF
          
          echo "Database 'backstage' created or already exists"
        env:
        - name: PGHOST
          value: timescaledb.heatpump-mqtt.svc.cluster.local
        - name: PGPORT
          value: "5432"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: backstage-database-secret
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: backstage-database-secret
              key: POSTGRES_PASSWORD
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: backstage-database-secret
              key: POSTGRES_PASSWORD








