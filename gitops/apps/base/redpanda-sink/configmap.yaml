apiVersion: v1
kind: ConfigMap
metadata:
  name: redpanda-sink-config
  namespace: redpanda-sink
data:
  config.yaml: |
    redpanda:
      brokers: "redpanda.redpanda.svc.cluster.local:9092"
      group_id: "redpanda-sink"
      auto_offset_reset: "earliest"
    
    database:
      url: "postgresql://$(DATABASE_USER):$(DATABASE_PASSWORD)@timescaledb.heatpump-mqtt.svc.cluster.local:5432/timescaledb"
      write:
        batch_size: 500
        linger_ms: 500
    
    pipelines:
      - name: "heatpump"
        topic: "heatpump-telemetry"
        table: "heatpump_new"
        data_type: "timeseries"
        timestamp:
          path: "$.ts"
          format: "rfc3339"
        tags: {}
        fields:
          outdoor_temp: { 
            path: "$.fields.outdoor_temp", 
            type: "float" 
          }
          supplyline_temp: { 
            path: "$.fields.supplyline_temp", 
            type: "float" 
          }
          returnline_temp: {
            path: "$.fields.returnline_temp",
            type: "float"
          }
          hotwater_temp: {
            path: "$.fields.hotwater_temp",
            type: "int"
          }
          brine_out_temp: {
            path: "$.fields.brine_out_temp",
            type: "int"
          }
          brine_in_temp: {
            path: "$.fields.brine_in_temp",
            type: "int"
          }
          integral: {
            path: "$.fields.integral",
            type: "int"
          }
          flowlinepump_speed: {
            path: "$.fields.flowlinepump_speed",
            type: "int"
          }
          brinepump_speed: {
            path: "$.fields.brinepump_speed",
            type: "int"
          }    
          runtime_compressor: {
            path: "$.fields.runtime_compressor",
            type: "int"
          } 
          runtime_hotwater: {
            path: "$.fields.runtime_hotwater",
            type: "int"
          } 
          runtime_3kw: {
            path: "$.fields.runtime_3kw",
            type: "int"
          }    
          runtime_6kw: {
            path: "$.fields.runtime_6kw",
            type: "int"
          }
          brinepump_on: {
            path: "$.fields.brinepump_on",
            type: "bool"
          }
          compressor_on: {
            path: "$.fields.compressor_on",
            type: "bool"
          }
          flowlinepump_on: {
            path: "$.fields.flowlinepump_on",
            type: "bool"
          }
          hotwater_production: {
            path: "$.fields.hotwater_production",
            type: "bool"
          }
          circulation_pump: {
            path: "$.fields.circulation_pump",
            type: "bool"
          }
          aux_heater_3kw_on: {
            path: "$.fields.aux_heater_3kw_on",
            type: "bool"
          }
          aux_heater_6kw_on: {
            path: "$.fields.aux_heater_6kw_on",
            type: "bool"
          }
      - name: "sensors"
        topic: "sensor-state"
        table: "telemetry_new"
        data_type: "timeseries"
        timestamp:
          use_now: true
        tags:
          sensor: "$.name"
          location: "$.location"
        fields:
          temperature_c:
            path: "$.temperature"
            type: "float"
          humidity_pct:
            path: "$.humidity"
            type: "float"
      - name: "energy"  
        topic: "energy-realtime"
        table: "energy_new"
        data_type: "timeseries"
        store_interval: "MINUTE"
        timestamp:
          path: "$.timestamp"
          format: "iso8601"
          use_now: true
        fields:
          activeTotalConsumption:
            path: "$.activeTotalConsumption"
            type: "nested" 
            attributes:
              total: "consumption_total_w"
              L1: "consumption_l1_w"
              L2: "consumption_l2_w"
              L3: "consumption_l3_w"

