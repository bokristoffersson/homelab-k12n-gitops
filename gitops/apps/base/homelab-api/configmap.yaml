---
apiVersion: v1
kind: ConfigMap
metadata:
  name: homelab-api-config
  namespace: homelab-api
data:
  config.yaml: |
    database:
      url: "postgresql://$(DATABASE_USER):$(DATABASE_PASSWORD)@timescaledb.timescaledb.svc.cluster.local:5432/telemetry"

    api:
      host: "0.0.0.0"
      port: 8080

    auth:
      # Multi-issuer configuration for Authentik OAuth2 providers
      # Public clients use opaque tokens (introspection), confidential clients use JWTs
      issuers:
        # Heatpump Web - SPA frontend (public client, opaque tokens)
        - name: heatpump-web
          issuer: "https://authentik.k12n.com/application/o/heatpump-web/"
          introspection_url: "https://authentik.k12n.com/application/o/introspect/"
          # Client credentials for introspection (injected from SealedSecret)
          introspection_client_id: "$(INTROSPECTION_CLIENT_ID)"
          introspection_client_secret: "$(INTROSPECTION_CLIENT_SECRET)"

        # Homelab macOS - Native app (public client, opaque tokens)
        - name: homelab-macos
          issuer: "https://authentik.k12n.com/application/o/homelab-macos/"
          introspection_url: "https://authentik.k12n.com/application/o/introspect/"
          # Uses same introspection client as heatpump-web
          introspection_client_id: "$(INTROSPECTION_CLIENT_ID)"
          introspection_client_secret: "$(INTROSPECTION_CLIENT_SECRET)"

        # Claude MCP - Server-to-server (confidential client, JWT tokens)
        - name: claude-mcp
          issuer: "https://authentik.k12n.com/application/o/claude-mcp/"
          jwks_url: "https://authentik.k12n.com/application/o/claude-mcp/jwks/"

      # Placeholder for config parsing compatibility (legacy)
      jwt_secret: "placeholder"
