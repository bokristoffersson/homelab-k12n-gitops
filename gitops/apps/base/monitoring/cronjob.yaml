apiVersion: batch/v1
kind: CronJob
metadata:
  name: monitoring-health-check
  namespace: monitoring
spec:
  schedule: "*/15 * * * *"  # Every 15 minutes
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 1
      template:
        metadata:
          labels:
            app: monitoring-health-check
        spec:
          serviceAccountName: monitoring
          restartPolicy: OnFailure
          containers:
            - name: health-check
              image: alpine/k8s:1.30.7
              command:
                - /bin/sh
                - -c
                - |
                  apk add --no-cache curl bc
                  sh /scripts/check-health.sh
              env:
                - name: SLACK_WEBHOOK_URL
                  valueFrom:
                    secretKeyRef:
                      name: slack-webhook
                      key: SLACK_WEBHOOK_URL
              volumeMounts:
                - name: scripts
                  mountPath: /scripts
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 200m
                  memory: 256Mi
          volumes:
            - name: scripts
              configMap:
                name: monitoring-script
                defaultMode: 0755
