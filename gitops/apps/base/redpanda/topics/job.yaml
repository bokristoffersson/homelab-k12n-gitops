apiVersion: batch/v1
kind: Job
metadata:
  name: redpanda-topics-setup
  namespace: redpanda
  annotations:
    "fluxcd.io/ignore": "false"
spec:
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        # Wait for Redpanda to be ready
        - name: wait-for-redpanda
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              echo "Waiting for Redpanda to be ready..."
              until nc -z redpanda.redpanda.svc.cluster.local 9092; do
                echo "Waiting for Redpanda on port 9092..."
                sleep 2
              done
              echo "Redpanda is ready!"
        # Create topics
        - name: create-topics
          image: docker.redpanda.com/redpandadata/redpanda:v24.2.19
          command:
            - sh
            - -c
            - |
              set -e
              
              BROKERS="redpanda.redpanda.svc.cluster.local:9092"
              
              # Verify rpk is available
              echo "Checking if rpk is available..."
              if ! command -v rpk >/dev/null 2>&1; then
                echo "ERROR: rpk command not found in PATH"
                echo "PATH: $PATH"
                echo "Trying to find rpk..."
                find /usr -name rpk 2>/dev/null || echo "rpk not found"
                exit 1
              fi
              echo "rpk found: $(which rpk)"
              rpk --version || echo "Warning: Could not get rpk version"
              
              # Wait for Redpanda cluster to be ready (accept commands)
              echo "Waiting for Redpanda cluster to be ready..."
              for i in $(seq 1 30); do
                if rpk cluster info --brokers "$BROKERS" >/dev/null 2>&1; then
                  echo "Redpanda cluster is ready!"
                  break
                fi
                if [ $i -eq 30 ]; then
                  echo "ERROR: Redpanda cluster not ready after 60 seconds"
                  echo "Attempting to get cluster info with verbose output:"
                  rpk cluster info --brokers "$BROKERS" || true
                  exit 1
                fi
                echo "Waiting for cluster to be ready... ($i/30)"
                sleep 2
              done
              
              # Check and create heatpump-realtime topic (1 hour retention)
              if ! rpk topic describe heatpump-realtime --brokers "$BROKERS" >/dev/null 2>&1; then
                echo "Creating heatpump-realtime topic..."
                rpk topic create heatpump-realtime \
                  --brokers "$BROKERS" \
                  --partitions 1 \
                  --replicas 1 \
                  -c retention.ms=3600000 \
                  -c segment.ms=300000 || {
                  echo "ERROR: Failed to create heatpump-realtime topic"
                  exit 1
                }
                echo "heatpump-realtime topic created successfully"
              else
                echo "heatpump-realtime topic already exists"
              fi
              
              # Check and create energy-realtime topic (24 hours retention)
              if ! rpk topic describe energy-realtime --brokers "$BROKERS" >/dev/null 2>&1; then
                echo "Creating energy-realtime topic..."
                rpk topic create energy-realtime \
                  --brokers "$BROKERS" \
                  --partitions 1 \
                  --replicas 1 \
                  -c retention.ms=86400000 \
                  -c segment.ms=900000 || {
                  echo "ERROR: Failed to create energy-realtime topic"
                  exit 1
                }
                echo "energy-realtime topic created successfully"
              else
                echo "energy-realtime topic already exists"
              fi
              
              # Check and create heatpump-telemetry topic (1 hour retention)
              if ! rpk topic describe heatpump-telemetry --brokers "$BROKERS" >/dev/null 2>&1; then
                echo "Creating heatpump-telemetry topic..."
                rpk topic create heatpump-telemetry \
                  --brokers "$BROKERS" \
                  --partitions 1 \
                  --replicas 1 \
                  -c retention.ms=3600000 \
                  -c segment.ms=300000 || {
                  echo "ERROR: Failed to create heatpump-telemetry topic"
                  exit 1
                }
                echo "heatpump-telemetry topic created successfully"
              else
                echo "heatpump-telemetry topic already exists"
              fi
              
              # Check and create sensor-state topic (24 hours retention)
              if ! rpk topic describe sensor-state --brokers "$BROKERS" >/dev/null 2>&1; then
                echo "Creating sensor-state topic..."
                rpk topic create sensor-state \
                  --brokers "$BROKERS" \
                  --partitions 1 \
                  --replicas 1 \
                  -c retention.ms=86400000 \
                  -c segment.ms=900000 || {
                  echo "ERROR: Failed to create sensor-state topic"
                  exit 1
                }
                echo "sensor-state topic created successfully"
              else
                echo "sensor-state topic already exists"
              fi
              
              # List all topics to verify
              echo "Verifying topics..."
              rpk topic list --brokers "$BROKERS" || {
                echo "ERROR: Failed to list topics"
                exit 1
              }
              
              echo "Topic setup complete!"
      containers:
        - name: complete
          image: busybox:latest
          command: ["sh", "-c", "echo Topics setup job completed successfully"]
  backoffLimit: 3
  # Automatically clean up completed jobs after 5 minutes
  # This allows Flux to recreate the job if the spec changes
  ttlSecondsAfterFinished: 300

