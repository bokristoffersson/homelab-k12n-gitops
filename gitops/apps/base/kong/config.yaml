---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
  namespace: kong
data:
  kong.yml: |
    _format_version: "3.0"
    _transform: true

    # Backend Services
    services:
      # Redpanda Sink API
      - name: redpanda-sink
        url: http://redpanda-sink.redpanda-sink.svc.cluster.local:8080
        routes:
          - name: api-route
            paths:
              - /api/v1
            strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-Authenticated-User-Id:$(X-Userinfo-Sub)
                  - X-Authenticated-User-Email:$(X-Userinfo-Email)
                  - X-Authenticated-Scope:$(X-Userinfo-Scope)

      # Energy WebSocket Service
      - name: energy-ws
        url: http://energy-ws.energy-ws.svc.cluster.local:8080
        routes:
          - name: ws-route
            paths:
              - /ws
            strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-Authenticated-User-Id:$(X-Userinfo-Sub)
                  - X-Authenticated-User-Email:$(X-Userinfo-Email)
                  - X-Authenticated-Scope:$(X-Userinfo-Scope)

    # Global Plugins
    plugins:
      # OIDC Authentication with Authentik
      # Using kong-oidc plugin (third-party, installed in custom image)
      - name: oidc
        config:
          client_id: kong-api-gateway
          client_secret: dummy_secret_not_needed_for_bearer_validation
          discovery: http://authentik-server.authentik.svc.cluster.local:9000/application/o/kong-api-gateway/.well-known/openid-configuration
          introspection_endpoint: http://authentik-server.authentik.svc.cluster.local:9000/application/o/introspect/
          bearer_only: "yes"
          realm: kong
          introspection_endpoint_auth_method: client_secret_post
          ssl_verify: "no"
          scope: "openid profile email"
          response_type: code
          token_endpoint_auth_method: client_secret_post
