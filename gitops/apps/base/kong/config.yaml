---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
  namespace: kong
data:
  kong.yml: |
    _format_version: "3.0"
    _transform: true

    # Backend Services
    services:
      # Redpanda Sink API
      - name: redpanda-sink
        url: http://redpanda-sink.redpanda-sink.svc.cluster.local:8080
        routes:
          - name: api-route
            paths:
              - /api/v1
            strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-Authenticated-User-Id:$(X-Userinfo-Sub)
                  - X-Authenticated-User-Email:$(X-Userinfo-Email)
                  - X-Authenticated-Scope:$(X-Userinfo-Scope)

      # Energy WebSocket Service
      - name: energy-ws
        url: http://energy-ws.energy-ws.svc.cluster.local:8080
        routes:
          - name: ws-route
            paths:
              - /ws
            strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-Authenticated-User-Id:$(X-Userinfo-Sub)
                  - X-Authenticated-User-Email:$(X-Userinfo-Email)
                  - X-Authenticated-Scope:$(X-Userinfo-Scope)

    # Global Plugins
    plugins:
      # CORS must be first to handle preflight requests
      - name: cors
        config:
          origins:
            - https://heatpump.k12n.com
            - http://localhost:5173
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Authorization
            - Content-Type
            - Accept
          exposed_headers:
            - X-Auth-Token
          credentials: true
          max_age: 3600
          preflight_continue: false

      # OIDC Authentication with Authentik
      # Using kong-oidc plugin (third-party, installed in custom image)
      # Validates tokens issued by the heatpump-web OAuth2 provider
      - name: oidc
        config:
          client_id: heatpump-web
          client_secret: not_needed_for_public_client
          discovery: http://authentik-server.authentik.svc.cluster.local:9000/application/o/heatpump-web/.well-known/openid-configuration
          introspection_endpoint: http://authentik-server.authentik.svc.cluster.local:9000/application/o/introspect/
          bearer_only: "yes"
          realm: kong
          introspection_endpoint_auth_method: client_secret_post
          ssl_verify: "no"
          scope: "openid profile email"
          response_type: code
