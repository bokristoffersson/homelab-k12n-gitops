---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
  namespace: kong
data:
  kong.yml: |
    _format_version: "3.0"
    _transform: true

    # Backend Services
    services:
      # Redpanda Sink API
      - name: redpanda-sink
        url: http://redpanda-sink.redpanda-sink.svc.cluster.local:8080
        routes:
          - name: api-route
            paths:
              - /api/v1
            strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-Authenticated-User-Id:$(X-Userinfo-Sub)
                  - X-Authenticated-User-Email:$(X-Userinfo-Email)
                  - X-Authenticated-Scope:$(X-Userinfo-Scope)

      # Energy WebSocket Service
      - name: energy-ws
        url: http://energy-ws.energy-ws.svc.cluster.local:8080
        routes:
          - name: ws-route
            paths:
              - /ws
            strip_path: false
        plugins:
          - name: request-transformer
            config:
              add:
                headers:
                  - X-Authenticated-User-Id:$(X-Userinfo-Sub)
                  - X-Authenticated-User-Email:$(X-Userinfo-Email)
                  - X-Authenticated-Scope:$(X-Userinfo-Scope)

    # Global Plugins
    # NOTE: openid-connect plugin requires Kong Enterprise Edition
    # For now, Kong acts as a reverse proxy without authentication
    # TODO: Either use Kong Enterprise, build custom image with kong-oidc plugin,
    #       or implement authentication in backend services
    plugins: []
