---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
  namespace: kong
data:
  kong.yml: |
    _format_version: "3.0"
    _transform: true

    # Backend Services
    services:
      # Redpanda Sink API
      - name: redpanda-sink
        url: http://redpanda-sink.redpanda-sink.svc.cluster.local:8080
        routes:
          - name: api-route
            paths:
              - /api/v1
            strip_path: false
        # plugins:
        #   - name: request-transformer
        #     config:
        #       add:
        #         headers:
        #           - X-Authenticated-User-Id:$(X-Userinfo-Sub)
        #           - X-Authenticated-User-Email:$(X-Userinfo-Email)
        #           - X-Authenticated-Scope:$(X-Userinfo-Scope)

      # Energy WebSocket Service
      - name: energy-ws
        url: http://energy-ws.energy-ws.svc.cluster.local:8080
        routes:
          - name: ws-route
            paths:
              - /ws
            strip_path: false
        # plugins:
        #   - name: request-transformer
        #     config:
        #       add:
        #         headers:
        #           - X-Authenticated-User-Id:$(X-Userinfo-Sub)
        #           - X-Authenticated-User-Email:$(X-Userinfo-Email)
        #           - X-Authenticated-Scope:$(X-Userinfo-Scope)

    # Global Plugins
    plugins:
      # CORS must be first to handle preflight requests
      - name: cors
        config:
          origins:
            - https://heatpump.k12n.com
            - http://localhost:5173
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Authorization
            - Content-Type
            - Accept
          exposed_headers:
            - X-Auth-Token
          credentials: true
          max_age: 3600
          preflight_continue: false

      # OIDC Authentication with Authentik
      # Using kong-oidc plugin in bearer-only mode for API validation
      - name: oidc
        config:
          client_id: heatpump-web
          client_secret: dummy_not_used
          discovery: http://authentik-server.authentik.svc.cluster.local:9000/application/o/heatpump-web/.well-known/openid-configuration
          bearer_only: "yes"
          realm: kong
          ssl_verify: "no"
          scope: "openid profile email"
          ignore_auth_filters: ".*"
