apiVersion: v1
kind: ConfigMap
metadata:
  name: mqtt-input-config
  namespace: mqtt-input
data:
  config.yaml: |
    # MQTT to Redpanda bridge configuration
    mqtt:
      host: "mosquitto.mosquitto.svc.cluster.local"
      port: 1883
      client_id: "mqtt-input"
      keep_alive_secs: 30
      username: null
      password: null
      clean_session: true
      protocol: "v5"
    redpanda:
      # Will be overridden by REDPANDA_BROKERS env var
      brokers: "redpanda-v2.redpanda-v2.svc.cluster.local:9093"
    pipelines:
      # Energy data pipeline - SaveEye meter format
      - name: "energy-realtime"
        topic: "homelab/energy/realtime"
        qos: 1
        redpanda_topic: "homelab-energy-realtime"
        timestamp:
          path: "$.timestamp"
          format: "rfc3339"
          use_now: true
        tags:
          device_serial: "$.saveeyeDeviceSerialNumber"
          meter_type: "$.meterType"
        fields:
          wifi_rssi:
            path: "$.wifiRssi"
            type: "float"
          active_power_total:
            path: "$.activeActualConsumption.total"
            type: "float"
          active_power_l1:
            path: "$.activeActualConsumption.L1"
            type: "float"
          active_power_l2:
            path: "$.activeActualConsumption.L2"
            type: "float"
          active_power_l3:
            path: "$.activeActualConsumption.L3"
            type: "float"
          active_production_total:
            path: "$.activeActualProduction.total"
            type: "float"
          active_energy_total:
            path: "$.activeTotalConsumption.total"
            type: "float"
          active_energy_production:
            path: "$.activeTotalProduction.total"
            type: "float"
          reactive_power_consumption:
            path: "$.reactiveActualConsumption.total"
            type: "float"
          reactive_power_production:
            path: "$.reactiveActualProduction.total"
            type: "float"
          reactive_energy_consumption:
            path: "$.reactiveTotalConsumption.total"
            type: "float"
          reactive_energy_production:
            path: "$.reactiveTotalProduction.total"
            type: "float"
          voltage_l1:
            path: "$.rmsVoltage.L1"
            type: "float"
          voltage_l2:
            path: "$.rmsVoltage.L2"
            type: "float"
          voltage_l3:
            path: "$.rmsVoltage.L3"
            type: "float"
          current_l1:
            path: "$.rmsCurrent.L1"
            type: "float"
          current_l2:
            path: "$.rmsCurrent.L2"
            type: "float"
          current_l3:
            path: "$.rmsCurrent.L3"
            type: "float"
          power_factor:
            path: "$.powerFactor.total"
            type: "float"
      # Indoor temperature pipeline - Shelly HT G3 format
      - name: "temperature-indoor"
        topic: "homelab/temperature/indoor"
        qos: 1
        redpanda_topic: "homelab-temperature-indoor"
        timestamp:
          path: "$.timestamp"
          format: "rfc3339"
          use_now: true
        tags:
          device_id: "$.src"
          mac_address: "$.params.sys.mac"
          location: "indoor"
        fields:
          temperature_c:
            path: "$.params['temperature:0'].tC"
            type: "float"
          temperature_f:
            path: "$.params['temperature:0'].tF"
            type: "float"
          humidity:
            path: "$.params['humidity:0'].rh"
            type: "float"
          wifi_rssi:
            path: "$.params.wifi.rssi"
            type: "float"
          battery_voltage:
            path: "$.params['devicepower:0'].battery.V"
            type: "float"
          battery_percent:
            path: "$.params['devicepower:0'].battery.percent"
            type: "float"
          external_power:
            path: "$.params['devicepower:0'].external.present"
            type: "float"
          uptime:
            path: "$.params.sys.uptime"
            type: "float"
          ram_free:
            path: "$.params.sys.ram_free"
            type: "float"
      # Outdoor temperature pipeline - from mqtt-generator
      - name: "temperature-outdoor"
        topic: "homelab/temperature/outdoor"
        qos: 1
        redpanda_topic: "homelab-temperature-outdoor"
        timestamp:
          path: "$.timestamp"
          format: "rfc3339"
          use_now: true
        tags:
          source: "mqtt-generator"
          location: "outdoor"
        fields:
          temperature_c:
            path: "$.temperature_c"
            type: "float"
          humidity_pct:
            path: "$.humidity_pct"
            type: "float"
          wind_speed_ms:
            path: "$.wind_speed_ms"
            type: "float"
          pressure_hpa:
            path: "$.pressure_hpa"
            type: "float"
      # ThermIQ Heatpump telemetry - real format
      - name: "heatpump-thermiq"
        topic: "thermiq_heatpump/data"
        qos: 1
        redpanda_topic: "homelab-heatpump-telemetry"
        timestamp:
          path: "$.timestamp"
          format: "rfc3339"
          use_now: true
        tags:
          device_id: "thermiq-generator"
        fields:
          outdoor_temp:
            path: "$.d0"
            type: "float"
          supplyline_temp:
            path: "$.d5"
            type: "float"
          returnline_temp:
            path: "$.d6"
            type: "float"
          hotwater_temp:
            path: "$.d7"
            type: "float"
          brine_out_temp:
            path: "$.d8"
            type: "float"
          brine_in_temp:
            path: "$.d9"
            type: "float"
          flowlinepump_speed:
            path: "$.d30"
            type: "float"
          runtime_compressor:
            path: "$.d104"
            type: "float"
          runtime_hotwater:
            path: "$.d108"
            type: "float"
          runtime_3kw:
            path: "$.d106"
            type: "float"
          runtime_6kw:
            path: "$.d114"
            type: "float"
          indoor_temp:
            path: "$.INDR_T"
            type: "float"

