apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: timescaledb-cluster
  namespace: timescaledb
spec:
  teamId: "homelab"
  volume:
    size: 20Gi
    storageClass: longhorn

  numberOfInstances: 1  # Change to 2 for HA

  users:
    app_user:  # Application user - use this for your MQTT app
      - superuser
      - createdb

  databases:
    appdb: app_user  # Default database

  postgresql:
    version: "16"
    parameters:
      # Performance tuning for homelab
      max_connections: "100"
      shared_buffers: "512MB"
      effective_cache_size: "1536MB"
      maintenance_work_mem: "128MB"
      checkpoint_completion_target: "0.9"
      wal_buffers: "16MB"
      default_statistics_target: "100"
      random_page_cost: "1.1"
      effective_io_concurrency: "200"
      work_mem: "5242kB"
      min_wal_size: "1GB"
      max_wal_size: "4GB"
      max_worker_processes: "4"
      max_parallel_workers_per_gather: "2"
      max_parallel_workers: "4"
      max_parallel_maintenance_workers: "2"

  # Use TimescaleDB-enabled Spilo image
  dockerImage: ghcr.io/zalando/spilo-16:3.2-p3

  # Enable TimescaleDB extension for all databases
  preparedDatabases:
    appdb:
      extensions:
        timescaledb: public

  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 2Gi

  # Patroni configuration
  patroni:
    initdb:
      encoding: "UTF8"
      locale: "en_US.UTF-8"
      data-checksums: "true"
    pg_hba:
      - local all all trust
      - hostssl all all 0.0.0.0/0 md5
      - host all all 0.0.0.0/0 md5
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    synchronous_mode: false
    synchronous_mode_strict: false

  # Connection pooler (optional but recommended)
  enableConnectionPooler: true
  connectionPooler:
    numberOfInstances: 2
    mode: "transaction"
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi

  # Backup configuration - operator's built-in logical backup
  enableLogicalBackup: true
  logicalBackupSchedule: "0 2 * * *"  # Daily at 2 AM

  # Maintenance windows
  maintenanceWindows:
    - Mon:02:00-04:00
    - Sat:02:00-06:00